generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model School {
  id        Int      @id @default(autoincrement())
  name      String
  city      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  quizEvents QuizEvent[]
}

model QuizEvent {
  id    Int       @id @default(autoincrement())
  name  String
  date  DateTime
  level QuizLevel

  schoolId Int
  school   School @relation(fields: [schoolId], references: [id])

  rounds      Round[]
  teams       Team[]
  roundScores RoundScore[]

  eventState EventState?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum QuizLevel {
  JUNIOR
  SENIOR
}

model Team {
  id    Int    @id @default(autoincrement())
  name  String
  score Int    @default(0)

  quizEventId Int
  quizEvent   QuizEvent @relation(fields: [quizEventId], references: [id])

  answers      AnswerLog[]
  buzzerEvents BuzzerEvent[]
  roundScores  RoundScore[]
}

model Round {
  id    Int       @id @default(autoincrement())
  name  String
  order Int
  type  RoundType

  quizEventId Int
  quizEvent   QuizEvent @relation(fields: [quizEventId], references: [id])

  questions   Question[]
  roundScores RoundScore[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum RoundType {
  TIME_TELLER
  PUZZLE
  RAPID_FIRE
  BUZZER
}

model Question {
  id            Int             @id @default(autoincrement())
  text          String
  optionA       String?
  optionB       String?
  optionC       String?
  optionD       String?
  correctOption QuestionOption?
  mediaURL      String?
  timeLimitSec  Int
  points        Int
  orderInRound  Int
  type          QuestionType

  roundId Int
  round   Round @relation(fields: [roundId], references: [id])

  answers      AnswerLog[]
  buzzerEvents BuzzerEvent[] // <-- FIX added
}

enum QuestionType {
  MCQ
  PUZZLE
  RAPID
  BUZZER
}

enum QuestionOption {
  A
  B
  C
  D
}

model AnswerLog {
  id             Int             @id @default(autoincrement())
  teamId         Int
  questionId     Int
  selectedOption QuestionOption?
  isCorrect      Boolean
  pointsAwarded  Int
  answeredAt     DateTime        @default(now())

  team     Team     @relation(fields: [teamId], references: [id])
  question Question @relation(fields: [questionId], references: [id])
}

model RoundScore {
  id      Int @id @default(autoincrement())
  teamId  Int
  roundId Int
  score   Int @default(0)

  team        Team       @relation(fields: [teamId], references: [id])
  round       Round      @relation(fields: [roundId], references: [id])
  quizEvent   QuizEvent? @relation(fields: [quizEventId], references: [id])
  quizEventId Int?
}

model BuzzerEvent {
  id         Int      @id @default(autoincrement())
  teamId     Int
  questionId Int
  pressedAt  DateTime @default(now())

  team     Team     @relation(fields: [teamId], references: [id])
  question Question @relation(fields: [questionId], references: [id])
}

model EventState {
  id      Int       @id @default(autoincrement())
  eventId Int       @unique
  event   QuizEvent @relation(fields: [eventId], references: [id])

  currentRoundId    Int?
  currentQuestionId Int?

  isAnswerRevealed Boolean   @default(false)
  isFiftyUsed      Boolean   @default(false) // for current team in Round 1
  timerDeadline    DateTime? // when current timer will end (now + 30s / 60s)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
